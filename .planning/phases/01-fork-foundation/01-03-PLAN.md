---
phase: 01-fork-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - packages/opencode/src/auth/chinese-providers.ts
  - packages/app/src/components/ProviderSettings.tsx
  - packages/app/src/components/ApiKeyInput.tsx
autonomous: false

must_haves:
  truths:
    - "User can enter API key for any Chinese provider"
    - "API keys are stored securely (not plaintext in config)"
    - "User can select Chinese provider from provider list"
    - "Provider selection persists across sessions"
  artifacts:
    - path: "packages/opencode/src/auth/chinese-providers.ts"
      provides: "API key storage for Chinese providers"
      contains: "saveApiKey"
    - path: "packages/app/src/components/ProviderSettings.tsx"
      provides: "Provider selection UI"
      contains: "moonshot|zhipu|minimax"
  key_links:
    - from: "packages/app/src/components/ProviderSettings.tsx"
      to: "packages/opencode/src/auth/chinese-providers.ts"
      via: "API key save handler"
      pattern: "saveApiKey|setApiKey"
    - from: "packages/opencode/src/auth/chinese-providers.ts"
      to: "auth.json storage"
      via: "file system write"
      pattern: "writeFile.*auth\\.json"
---

<objective>
Implement API key authentication and provider configuration UI for Chinese LLM providers.

Purpose: Users need a way to configure their Chinese provider API keys and select which provider to use. This completes the Phase 1 goal of making Chinese providers usable.

Output: Working settings UI where users can enter API keys for Moonshot, Zhipu, and MiniMax, with keys stored securely and provider selection persisting.
</objective>

<execution_context>
@/Users/costantinomarcello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/costantinomarcello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-fork-foundation/01-RESEARCH.md
@.planning/phases/01-fork-foundation/01-01-SUMMARY.md
@.planning/phases/01-fork-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement API key storage for Chinese providers</name>
  <files>
    - packages/opencode/src/auth/chinese-providers.ts
    - packages/opencode/src/auth/index.ts
  </files>
  <action>
1. First, understand existing auth pattern:
   ```bash
   find packages/opencode/src -name "*auth*" -type f
   cat packages/opencode/src/auth/*.ts 2>/dev/null || ls packages/opencode/src/
   ```
   Look for how existing providers (Claude, OpenAI) store API keys.

2. Create Chinese provider auth module following existing pattern:
   ```typescript
   // packages/opencode/src/auth/chinese-providers.ts
   import { existsSync, mkdirSync, readFileSync, writeFileSync } from 'fs';
   import { homedir } from 'os';
   import { join } from 'path';

   // Auth storage location (matches OpenCode pattern from research)
   const AUTH_DIR = join(homedir(), '.local', 'share', 'codemad');
   const AUTH_FILE = join(AUTH_DIR, 'auth.json');

   export type ChineseProvider = 'moonshot' | 'zhipu' | 'minimax';

   interface AuthStorage {
     [providerId: string]: {
       apiKey?: string;
     };
   }

   function ensureAuthDir(): void {
     if (!existsSync(AUTH_DIR)) {
       mkdirSync(AUTH_DIR, { recursive: true });
     }
   }

   function loadAuth(): AuthStorage {
     ensureAuthDir();
     if (!existsSync(AUTH_FILE)) {
       return {};
     }
     try {
       return JSON.parse(readFileSync(AUTH_FILE, 'utf-8'));
     } catch {
       return {};
     }
   }

   function saveAuth(auth: AuthStorage): void {
     ensureAuthDir();
     writeFileSync(AUTH_FILE, JSON.stringify(auth, null, 2), { mode: 0o600 });
   }

   export function saveApiKey(provider: ChineseProvider, apiKey: string): void {
     const auth = loadAuth();
     auth[provider] = { apiKey };
     saveAuth(auth);
   }

   export function getApiKey(provider: ChineseProvider): string | undefined {
     // Check auth storage first, then env var
     const auth = loadAuth();
     if (auth[provider]?.apiKey) {
       return auth[provider].apiKey;
     }
     // Fallback to environment variable
     const envVarMap: Record<ChineseProvider, string> = {
       moonshot: 'MOONSHOT_API_KEY',
       zhipu: 'ZHIPU_API_KEY',
       minimax: 'MINIMAX_API_KEY',
     };
     return process.env[envVarMap[provider]];
   }

   export function hasApiKey(provider: ChineseProvider): boolean {
     return !!getApiKey(provider);
   }

   export function clearApiKey(provider: ChineseProvider): void {
     const auth = loadAuth();
     delete auth[provider];
     saveAuth(auth);
   }
   ```

3. Export from auth index (packages/opencode/src/auth/index.ts):
   - Add exports for saveApiKey, getApiKey, hasApiKey, clearApiKey

Note from research: Auth storage uses ~/.local/share/codemad/auth.json with file permissions 0o600 (read/write owner only).
  </action>
  <verify>
    - File exists: `test -f packages/opencode/src/auth/chinese-providers.ts`
    - TypeScript compiles: `bun run typecheck`
    - Exports are correct: `grep -E "export.*saveApiKey|getApiKey" packages/opencode/src/auth/chinese-providers.ts`
  </verify>
  <done>
    Chinese provider auth module exists with saveApiKey, getApiKey, hasApiKey, clearApiKey functions, using secure file storage
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Chinese providers to settings UI</name>
  <files>
    - packages/app/src/components/ProviderSettings.tsx (or equivalent settings component)
    - packages/app/src/components/ApiKeyInput.tsx (create if needed)
  </files>
  <action>
1. First, find existing settings/provider UI:
   ```bash
   find packages/app/src -name "*Settings*" -o -name "*Provider*" -o -name "*Config*" | head -20
   grep -r "provider" packages/app/src/components/ --include="*.tsx" -l
   ```

2. Understand the existing provider UI pattern by reading the found files

3. Add Chinese providers to the provider list:
   - Moonshot AI (Kimi) with kimi-k2.5 and kimi-k2.5-thinking models
   - Zhipu AI (GLM) with glm-4.7 and glm-4.7-flash models
   - MiniMax with minimax-m2.1 model

4. Create or update API key input component:
   ```tsx
   // packages/app/src/components/ApiKeyInput.tsx (if creating new)
   import { createSignal } from 'solid-js';

   interface ApiKeyInputProps {
     provider: string;
     providerName: string;
     onSave: (apiKey: string) => void;
     hasExisting: boolean;
   }

   export function ApiKeyInput(props: ApiKeyInputProps) {
     const [apiKey, setApiKey] = createSignal('');
     const [showKey, setShowKey] = createSignal(false);

     return (
       <div class="api-key-input">
         <label>{props.providerName} API Key</label>
         <div class="input-group">
           <input
             type={showKey() ? 'text' : 'password'}
             value={apiKey()}
             onInput={(e) => setApiKey(e.currentTarget.value)}
             placeholder={props.hasExisting ? '••••••••' : 'Enter API key'}
           />
           <button onClick={() => setShowKey(!showKey())}>
             {showKey() ? 'Hide' : 'Show'}
           </button>
           <button onClick={() => props.onSave(apiKey())}>
             Save
           </button>
         </div>
         {props.hasExisting && (
           <span class="status">API key configured</span>
         )}
       </div>
     );
   }
   ```

5. Integrate with existing settings UI:
   - Add section for "Chinese Providers" or integrate into existing provider list
   - Show API key input for each Chinese provider
   - Wire up save handler to chinese-providers.ts saveApiKey function

Note: CodeMAD uses SolidJS (not React), so use createSignal instead of useState.
  </action>
  <verify>
    - Chinese providers appear in settings UI code: `grep -r "moonshot\|zhipu\|minimax" packages/app/src/components/`
    - API key input component exists
    - Build succeeds: `bun run build`
  </verify>
  <done>
    Settings UI includes Chinese provider configuration with API key input fields, connected to auth storage
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Chinese provider configuration flow:
    1. API key storage in ~/.local/share/codemad/auth.json
    2. Settings UI with Chinese provider options
    3. API key input with secure storage
  </what-built>
  <how-to-verify>
    1. Start the CodeMAD desktop app:
       ```bash
       bun run dev
       ```

    2. Open Settings (Cmd/Ctrl + , or via menu)

    3. Navigate to Providers section

    4. Verify Chinese providers are listed:
       - Moonshot AI (Kimi)
       - Zhipu AI (GLM)
       - MiniMax

    5. Enter a test API key for one provider (can be fake for UI testing)

    6. Verify the key is saved:
       ```bash
       cat ~/.local/share/codemad/auth.json
       ```
       (Should show provider with masked key)

    7. Restart the app and verify the provider shows as configured

    8. Test provider selection persists:
       - Select a Chinese provider as default
       - Restart app
       - Verify selection is remembered

    Expected: All Chinese providers visible in settings, API keys can be entered and are persisted securely.
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. Auth storage works:
   ```bash
   # After saving a key via UI:
   test -f ~/.local/share/codemad/auth.json && echo "Auth file exists"
   stat -f "%Lp" ~/.local/share/codemad/auth.json  # macOS: should show 600
   ```

2. UI integration:
   - Chinese providers visible in settings
   - API key input functional
   - Status shows "configured" when key is saved

3. Provider selection:
   - Can select Chinese provider from list
   - Selection persists across restarts
</verification>

<success_criteria>
1. API key storage module exists with secure file permissions (0o600)
2. Settings UI shows all three Chinese providers
3. API key input works with show/hide toggle
4. Saved keys persist in auth.json
5. Provider selection persists across app restarts
6. Human verification confirms end-to-end flow works
</success_criteria>

<output>
After completion, create `.planning/phases/01-fork-foundation/01-03-SUMMARY.md`
</output>
