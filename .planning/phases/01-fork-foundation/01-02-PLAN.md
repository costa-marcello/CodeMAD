---
phase: 01-fork-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - packages/opencode/src/provider/moonshot.ts
  - packages/opencode/src/provider/index.ts
  - codemad.json (or opencode.json)
autonomous: true

user_setup:
  - service: moonshot
    why: "Kimi K2.5 LLM provider"
    env_vars:
      - name: MOONSHOT_API_KEY
        source: "Moonshot Platform -> API Keys (platform.moonshot.ai)"
  - service: zhipu
    why: "GLM 4.7 LLM provider"
    env_vars:
      - name: ZHIPU_API_KEY
        source: "Zhipu BigModel -> API Keys (open.bigmodel.cn)"
  - service: minimax
    why: "MiniMax M2.1 LLM provider"
    env_vars:
      - name: MINIMAX_API_KEY
        source: "MiniMax Platform -> API Keys (platform.minimax.io)"

must_haves:
  truths:
    - "User can select Kimi K2.5 as their LLM provider"
    - "User can select GLM 4.7 as their LLM provider"
    - "User can select MiniMax M2.1 as their LLM provider"
    - "Each provider connects to correct API endpoint"
  artifacts:
    - path: "packages/opencode/src/provider/moonshot.ts"
      provides: "Moonshot/Kimi provider implementation"
      contains: "createOpenAICompatible"
    - path: "codemad.json"
      provides: "Provider configuration"
      contains: "moonshot"
  key_links:
    - from: "packages/opencode/src/provider/moonshot.ts"
      to: "@ai-sdk/openai-compatible"
      via: "import createOpenAICompatible"
      pattern: "import.*openai-compatible"
    - from: "codemad.json"
      to: "packages/opencode/src/provider/index.ts"
      via: "provider registry lookup"
      pattern: "provider.*moonshot|zhipu|minimax"
---

<objective>
Add Chinese LLM provider support (Kimi K2.5, GLM 4.7, MiniMax M2.1) to CodeMAD.

Purpose: Chinese LLM providers are a key differentiator for CodeMAD. This enables users in China and those who prefer Chinese AI models to use CodeMAD with their preferred providers.

Output: Three working Chinese LLM providers registered in CodeMAD, with proper API configuration for both global and China endpoints.
</objective>

<execution_context>
@/Users/costantinomarcello/.claude/get-shit-done/workflows/execute-plan.md
@/Users/costantinomarcello/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-fork-foundation/01-RESEARCH.md
@.planning/phases/01-fork-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install provider packages and create Moonshot provider</name>
  <files>
    - package.json (root)
    - packages/opencode/package.json
    - packages/opencode/src/provider/moonshot.ts
  </files>
  <action>
1. Install required packages:
   ```bash
   bun add zhipu-ai-provider vercel-minimax-ai-provider @ai-sdk/openai-compatible
   ```

2. Create Moonshot/Kimi provider (packages/opencode/src/provider/moonshot.ts):
   ```typescript
   // Moonshot AI (Kimi K2.5) provider using OpenAI-compatible API
   // Source: https://ai-sdk.dev/providers/openai-compatible-providers/custom-providers
   import { createOpenAICompatible } from '@ai-sdk/openai-compatible';

   export interface MoonshotProviderOptions {
     apiKey?: string;
     baseURL?: string;
   }

   export function createMoonshot(options: MoonshotProviderOptions = {}) {
     const apiKey = options.apiKey ?? process.env.MOONSHOT_API_KEY;
     // Default to global endpoint; China users can override with baseURL
     const baseURL = options.baseURL ?? 'https://api.moonshot.cn/v1';

     if (!apiKey) {
       throw new Error('MOONSHOT_API_KEY is required. Set it in environment or pass apiKey option.');
     }

     return createOpenAICompatible({
       name: 'moonshot',
       baseURL,
       headers: {
         Authorization: `Bearer ${apiKey}`,
       },
     });
   }

   // Default export for convenience
   export const moonshot = createMoonshot();
   ```

3. Add exports to provider index (packages/opencode/src/provider/index.ts):
   - Import and re-export moonshot, createMoonshot
   - Follow existing pattern for other providers in the file

Note: The zhipu-ai-provider and vercel-minimax-ai-provider packages handle their own provider creation - we just need to import and configure them.
  </action>
  <verify>
    - `bun pm ls | grep -E "zhipu|minimax|openai-compatible"` shows all three packages installed
    - `cat packages/opencode/src/provider/moonshot.ts` exists and exports createMoonshot
    - TypeScript compiles without errors: `bun run typecheck`
  </verify>
  <done>
    All three provider packages installed, custom Moonshot provider created with createOpenAICompatible pattern, provider index updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Chinese providers in codemad.json</name>
  <files>
    - codemad.json (or opencode.json - check which config file CodeMAD uses)
  </files>
  <action>
1. First, check which config file exists and what format it uses:
   ```bash
   ls *.json
   cat opencode.json 2>/dev/null || cat codemad.json 2>/dev/null
   ```

2. Add Chinese provider configurations (merge with existing provider config):
   ```json
   {
     "provider": {
       "moonshot": {
         "npm": "./src/provider/moonshot",
         "name": "Moonshot AI (Kimi)",
         "options": {
           "baseURL": "https://api.moonshot.cn/v1",
           "apiKey": "{env:MOONSHOT_API_KEY}"
         },
         "models": {
           "kimi-k2.5": {
             "name": "Kimi K2.5",
             "limit": {
               "context": 256000,
               "output": 128000
             }
           },
           "kimi-k2.5-thinking": {
             "name": "Kimi K2.5 (Thinking)",
             "limit": {
               "context": 256000,
               "output": 128000
             }
           }
         }
       },
       "zhipu": {
         "npm": "zhipu-ai-provider",
         "name": "Zhipu AI (GLM)",
         "options": {
           "baseURL": "https://open.bigmodel.cn/api/paas/v4",
           "apiKey": "{env:ZHIPU_API_KEY}"
         },
         "models": {
           "glm-4.7": {
             "name": "GLM 4.7",
             "limit": {
               "context": 200000,
               "output": 128000
             }
           },
           "glm-4.7-flash": {
             "name": "GLM 4.7 Flash",
             "limit": {
               "context": 200000,
               "output": 128000
             }
           }
         }
       },
       "minimax": {
         "npm": "vercel-minimax-ai-provider",
         "name": "MiniMax",
         "options": {
           "baseURL": "https://api.minimax.io/anthropic/v1",
           "apiKey": "{env:MINIMAX_API_KEY}"
         },
         "models": {
           "minimax-m2.1": {
             "name": "MiniMax M2.1",
             "limit": {
               "context": 200000,
               "output": 65536
             }
           }
         }
       }
     }
   }
   ```

3. Include regional endpoint comments for documentation:
   - Moonshot: China endpoint same as global (api.moonshot.cn)
   - Zhipu: Global is api.z.ai, China is open.bigmodel.cn (default to China)
   - MiniMax: Global is api.minimax.io, China is api.minimaxi.com (default to global)

Note from research: These endpoints differ by region. Users can override in their local config.
  </action>
  <verify>
    - `cat codemad.json | grep -E "moonshot|zhipu|minimax"` shows all three providers
    - JSON is valid: `bun -e "console.log(JSON.parse(require('fs').readFileSync('codemad.json')))"`
    - Each provider has models array with context/output limits
  </verify>
  <done>
    codemad.json contains all three Chinese providers with correct API endpoints, model configurations, and context limits
  </done>
</task>

<task type="auto">
  <name>Task 3: Test provider integration</name>
  <files>
    - packages/opencode/src/provider/*.ts
    - test/providers.test.ts (create if needed)
  </files>
  <action>
1. Create a simple test file to verify provider imports work:
   ```typescript
   // test/providers.test.ts or packages/opencode/test/providers.test.ts
   import { describe, test, expect } from 'bun:test';
   import { createMoonshot } from '../src/provider/moonshot';
   import { zhipu } from 'zhipu-ai-provider';
   import { minimax } from 'vercel-minimax-ai-provider';

   describe('Chinese LLM Providers', () => {
     test('moonshot provider can be created', () => {
       // Will throw if MOONSHOT_API_KEY not set, but import works
       expect(createMoonshot).toBeDefined();
       expect(typeof createMoonshot).toBe('function');
     });

     test('zhipu provider exports correctly', () => {
       expect(zhipu).toBeDefined();
     });

     test('minimax provider exports correctly', () => {
       expect(minimax).toBeDefined();
     });
   });
   ```

2. Run the test:
   ```bash
   bun test test/providers.test.ts
   ```

3. Verify TypeScript compilation:
   ```bash
   bun run typecheck
   ```

4. Document in README or CHANGELOG that Chinese providers are now available

Note: Full integration testing requires API keys, which user will provide. This task verifies the plumbing works.
  </action>
  <verify>
    - `bun test` passes (provider import tests)
    - `bun run typecheck` passes
    - No import errors for zhipu-ai-provider or vercel-minimax-ai-provider
  </verify>
  <done>
    All three Chinese providers can be imported and instantiated, TypeScript compiles cleanly, basic tests pass
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Package verification:
   ```bash
   bun pm ls | grep -E "zhipu|minimax|openai-compatible"
   ```
   All three packages should be listed

2. Provider configuration:
   ```bash
   cat codemad.json | jq '.provider | keys'
   ```
   Should include: moonshot, zhipu, minimax

3. Build verification:
   ```bash
   bun run build
   bun run typecheck
   ```
   No errors

4. Test verification:
   ```bash
   bun test
   ```
   Provider tests pass
</verification>

<success_criteria>
1. Three new packages installed: zhipu-ai-provider, vercel-minimax-ai-provider, @ai-sdk/openai-compatible
2. Custom Moonshot provider exists at packages/opencode/src/provider/moonshot.ts
3. codemad.json contains provider configurations for all three Chinese providers
4. Each provider has correct API endpoint and model configurations
5. TypeScript compiles without errors
6. Basic provider import tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-fork-foundation/01-02-SUMMARY.md`
</output>
